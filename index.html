<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Visualizer</title>
    <!-- Tailwind CSS (For development only - Use PostCSS plugin or Tailwind CLI for production: https://tailwindcss.com/docs/installation) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Prism.js for code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Adjust the heights of the preview and HTML output sections */
        #html-output, #preview-iframe {
            height: 500px; /* Increase from default height */
            min-height: 500px;
        }
        
        /* Memory optimization: Don't highlight very large HTML content */
        .large-content {
            white-space: pre-wrap;
            font-family: monospace;
            overflow: auto;
            background-color: #2d2d2d;
            color: #ccc;
            padding: 1em;
            border-radius: 0.5em;
        }
        
        /* Set virtual rendering for large content */
        #html-output {
            contain: strict;
            overflow: auto;
        }
        
        /* Use a fixed layout for preview iframe to reduce reflow operations */
        #preview-iframe {
            width: 100%;
            border: none;
            background: white;
        }
        
        /* Optimize for large content rendering */
        .result-section {
            contain: content;
        }
        
        /* Add loading indicator for iframe */
        .iframe-container {
            position: relative;
        }
        
        .iframe-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background: rgba(255,255,255,0.8);
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Ensure consistent spacing */
        .result-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            height: 100%;
        }
        
        /* Fix spacing between sections */
        .section-gap {
            margin-bottom: 1.5rem;
        }
        
        /* Ensure the result section has proper spacing */
        #result-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        /* Processing animation improvements */
        .animate-progress {
            transition: width 0.5s ease;
        }
        
        /* Animation stopped state */
        .processing-complete .progress-bar {
            width: 100% !important;
            transition: width 0.3s ease;
        }
        
        /* Visually enhanced header */
        .header-gradient {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
        }
        
        /* Steps styling for How to Use section */
        .step-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .step-card {
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .step-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            margin-bottom: 1rem;
            font-weight: bold;
        }
        
        /* Example section styling */
        .example-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .example-card {
            border-radius: 0.75rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .example-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .example-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center text-center md:text-left">
                <h1 class="text-5xl font-bold text-white mb-4 flex items-center justify-center md:justify-start">
                    <i class="fas fa-wand-magic-sparkles text-yellow-300 mr-3"></i>
                    File Visualizer
                </h1>
                <div class="max-w-2xl md:text-right flex flex-col items-center md:items-end">
                    <p class="text-blue-100 text-xl mb-3">
                        Transform your plain documents into stunning, interactive websites
                    </p>
                    <div class="bg-blue-700/50 rounded-lg p-3 mt-1 inline-flex items-center">
                        <div class="flex items-center text-white">
                            <div class="mr-2 text-center">
                                <i class="fas fa-file-alt text-3xl text-gray-300"></i>
                                <div class="text-xs mt-1">Plain Document</div>
                            </div>
                            <i class="fas fa-arrow-right mx-3 text-blue-300"></i>
                            <div class="mx-2 text-center relative">
                                <i class="fas fa-wand-magic-sparkles text-3xl text-yellow-300 animate-pulse"></i>
                                <div class="absolute inset-0 rounded-full bg-blue-500/30 animate-ping" style="animation-duration: 3s;"></div>
                            </div>
                            <i class="fas fa-arrow-right mx-3 text-blue-300"></i>
                            <div class="ml-2 text-center">
                                <i class="fas fa-file-code text-3xl text-yellow-200"></i>
                                <div class="text-xs mt-1">Interactive Website</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Examples Section - Now before How to Use -->
    <div class="bg-gradient-to-r from-primary-50 to-blue-50 py-14">
        <div class="container mx-auto px-6">
            <div class="bg-white rounded-lg shadow-lg p-10 mb-6">
                <h2 class="text-3xl font-semibold mb-10 text-center">
                    <i class="fas fa-star text-primary-500 mr-2"></i>
                    See What's Possible
                </h2>
                
                <div class="example-grid">
                    <div class="example-card bg-white shadow-lg hover:shadow-xl cursor-pointer" onclick="window.open('https://egkxhslu0z.yourware.so/', '_blank')">
                        <div class="bg-blue-500 h-48 flex items-center justify-center">
                            <i class="fas fa-book text-white text-7xl"></i>
                        </div>
                        <div class="p-5">
                            <h4 class="font-medium text-lg mb-2">Scoping Reviews Guide</h4>
                            <p class="text-gray-600">Academic guide transformed into an interactive, navigable web page with clear sections and visual hierarchy.</p>
                            <div class="mt-3 text-primary-600 flex items-center">
                                <span>View Example</span>
                                <i class="fas fa-external-link-alt ml-2"></i>
                            </div>
                        </div>
                    </div>
                    <div class="example-card bg-white shadow-lg hover:shadow-xl cursor-pointer" onclick="window.open('https://mk9wzcfz6q.yourware.so/', '_blank')">
                        <div class="bg-green-500 h-48 flex items-center justify-center">
                            <i class="fas fa-graduation-cap text-white text-7xl"></i>
                        </div>
                        <div class="p-5">
                            <h4 class="font-medium text-lg mb-2">Educational Training Material</h4>
                            <p class="text-gray-600">Training material transcript converted into an elegant, branded learning experience with enhanced readability.</p>
                            <div class="mt-3 text-green-600 flex items-center">
                                <span>View Example</span>
                                <i class="fas fa-external-link-alt ml-2"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-8">
                    <p class="text-2xl font-bold text-primary-600 bg-primary-50 py-3 px-6 rounded-full inline-block shadow-sm">
                        ✨ These visualizations were created with a single prompt using File Visualizer! ✨
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- How to Use Section -->
    <div class="bg-gray-50 py-14">
        <div class="container mx-auto px-6">
            <h2 class="text-4xl font-semibold mb-12 text-center">
                <i class="fas fa-book-open text-gray-700 mr-2"></i>
                How to Use
            </h2>
            
            <div class="step-container">
                <!-- Step 1: API Key -->
                <div class="step-card bg-purple-50 border border-purple-200">
                    <div class="step-number bg-purple-500 text-white">1</div>
                    <h3 class="text-xl font-medium mb-2 text-purple-700">Enter Your API Key</h3>
                    <p class="text-gray-700 mb-2">
                        This app is <strong>completely free</strong> to use, but requires an Anthropic API key.
                    </p>
                    <p class="bg-red-50 border-l-4 border-red-500 text-red-700 p-3 mb-2 font-medium">
                        <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                        <strong>Important:</strong> You'll only be charged by Anthropic for the API usage. Keep your API key confidential and never share it with others.
                    </p>
                    <div class="mt-auto">
                        <details class="mt-2">
                            <summary class="cursor-pointer text-purple-600 hover:underline">
                                How to get an API key?
                            </summary>
                            <div class="pl-4 mt-2 text-sm">
                                <ol class="list-decimal pl-4 space-y-1">
                                    <li>Visit <a href="https://console.anthropic.com/" target="_blank" class="text-purple-600 hover:underline">Anthropic Console</a></li>
                                    <li>Sign up or log in to your account</li>
                                    <li>Navigate to "API Keys" section</li>
                                    <li>Create a new API key (starts with "sk-ant-")</li>
                                    <li>Copy the key (you'll only see it once!)</li>
                                </ol>
                            </div>
                        </details>
                    </div>
                </div>
                
                <!-- Step 2: Upload content -->
                <div class="step-card bg-blue-50 border border-blue-200">
                    <div class="step-number bg-blue-500 text-white">2</div>
                    <h3 class="text-xl font-medium mb-2 text-blue-700">Upload Your Content</h3>
                    <p class="text-gray-700 mb-2">
                        Upload a file or paste your text that you want to transform into a beautiful webpage.
                    </p>
                    <p class="text-gray-600 text-sm mb-2">
                        Supported formats: PDF, DOCX, TXT, HTML, MD, CSV, JSON, and more.
                    </p>
                    <div class="mt-auto">
                        <details class="mt-2">
                            <summary class="cursor-pointer text-blue-600 hover:underline">
                                Size limits and token calculation
                            </summary>
                            <div class="pl-4 mt-2 text-sm">
                                <p>The application will automatically count the tokens in your content and estimate the input cost.</p>
                                <ul class="list-disc pl-4 mt-1">
                                    <li>Maximum input: 128K tokens (approx. 100 pages)</li>
                                    <li>Cost: Approx. $3 per million input tokens</li>
                                    <li>Typical generation: $0.20-$2.00 total</li>
                                </ul>
                            </div>
                        </details>
                    </div>
                </div>
                
                <!-- Step 3: Customize -->
                <div class="step-card bg-indigo-50 border border-indigo-200">
                    <div class="step-number bg-indigo-500 text-white">3</div>
                    <h3 class="text-xl font-medium mb-2 text-indigo-700">Customize Settings</h3>
                    <p class="text-gray-700 mb-2">
                        Add custom instructions like "Make it look professional" or "Use a dark theme with gold accents".
                    </p>
                    <div class="mt-auto">
                        <details class="mt-2">
                            <summary class="cursor-pointer text-indigo-600 hover:underline">
                                Tips for customization
                            </summary>
                            <div class="pl-4 mt-2 text-sm">
                                <p>In the "Additional Instructions" box:</p>
                                <ul class="list-disc pl-4 mt-1">
                                    <li>Request specific visual styles or layouts</li>
                                    <li>Add links to images you want included</li>
                                    <li>Suggest specific data visualizations</li>
                                    <li>If not satisfied with the first result, add more specific requirements and regenerate</li>
                                </ul>
                            </div>
                        </details>
                    </div>
                </div>
                
                <!-- Step 4: Generate and Deploy -->
                <div class="step-card bg-green-50 border border-green-200">
                    <div class="step-number bg-green-500 text-white">4</div>
                    <h3 class="text-xl font-medium mb-2 text-green-700">Generate & Deploy</h3>
                    <p class="text-gray-700 mb-2">
                        Click "Generate" and watch as your document is transformed into beautiful HTML!
                    </p>
                    <p class="text-gray-600 text-sm mb-2">
                        <i class="fas fa-wifi mr-1"></i> <strong>Important:</strong> Keep your internet connection stable during this process. Generation takes 5-20 minutes depending on content size.
                    </p>
                    <div class="mt-auto">
                        <details class="mt-2">
                            <summary class="cursor-pointer text-green-600 hover:underline">
                                Deploying your HTML file
                            </summary>
                            <div class="pl-4 mt-2 text-sm">
                                <p>Once generated, you can:</p>
                                <ul class="list-disc pl-4 mt-1">
                                    <li>Download the complete HTML file</li>
                                    <li>Deploy it for free using:
                                        <ul class="list-circle pl-4 mt-1">
                                            <li><a href="https://github.io" target="_blank" class="text-green-600 hover:underline">GitHub Pages</a></li>
                                            <li><a href="https://netlify.drop" target="_blank" class="text-green-600 hover:underline">Netlify Drop</a></li>
                                            <li><a href="https://surge.sh" target="_blank" class="text-green-600 hover:underline">Surge.sh</a></li>
                                            <li><a href="https://vercel.com" target="_blank" class="text-green-600 hover:underline">Vercel</a></li>
                                        </ul>
                                    </li>
                                    <li>Share the link with anyone</li>
                                </ul>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4 md:p-6 animate-fade-in">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Input Section -->
            <div class="lg:col-span-5 space-y-6">
                <!-- API Key -->
                <div id="api-key-section" class="bg-white rounded-lg shadow-md p-5 transition-all hover:shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-key text-primary-500 mr-2"></i>Anthropic API Key
                    </h2>
                    <div class="mb-4">
                        <input type="password" id="api-key" placeholder="Enter your Anthropic API key" 
                            class="w-full p-3 border border-gray-300 rounded-md bg-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all">
                        <p class="text-sm text-gray-500 mt-2">
                            Your API key is stored locally in your browser and never sent to our servers.
                        </p>
                    </div>
                    <button id="validate-key" class="bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-md transition-colors">
                        <i class="fas fa-check-circle mr-2"></i>Validate Key
                    </button>
                    <div id="key-status" class="mt-3 hidden">
                        <!-- Will be filled by JS -->
                    </div>
                </div>

                <!-- File Upload / Text Input -->
                <div class="bg-white rounded-lg shadow-md p-5 transition-all hover:shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-file-upload text-primary-500 mr-2"></i>Input Source
                    </h2>
                    
                    <div class="mb-4">
                        <div class="flex space-x-3 mb-4">
                            <button id="file-tab" class="flex-1 py-2 px-4 rounded-md bg-primary-100 text-primary-700 font-medium">
                                <i class="fas fa-file mr-2"></i>Upload File
                            </button>
                            <button id="text-tab" class="flex-1 py-2 px-4 rounded-md bg-gray-100 text-gray-700 font-medium">
                                <i class="fas fa-keyboard mr-2"></i>Enter Text
                            </button>
                        </div>
                        
                        <!-- File Upload -->
                        <div id="file-input" class="transition-all">
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-primary-500 transition-colors" id="drop-area">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                <p class="mb-2">Drag & drop a file here, or <span class="text-primary-500">browse</span></p>
                                <input type="file" id="file-upload" class="hidden" accept=".txt,.md,.json,.csv,.html,.js,.css,.py,.pdf,.doc,.docx">
                                <p class="text-sm text-gray-500">Supported file types: txt, md, json, csv, html, js, css, py, pdf, doc, docx</p>
                            </div>
                            <div id="file-info" class="mt-3 hidden">
                                <!-- Will be filled by JS when file is uploaded -->
                            </div>
                        </div>
                        
                        <!-- Text Input -->
                        <div id="text-input" class="hidden transition-all">
                            <textarea id="input-text" rows="6" placeholder="Enter or paste your text here..." 
                                class="w-full p-3 border border-gray-300 rounded-md bg-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all"></textarea>
                        </div>
                        
                        <!-- Token Info - Moved outside both input types so it's visible for both -->
                        <div id="tokenInfo" class="mt-3">
                            <!-- Will be filled by JS when file is uploaded or text is entered -->
                        </div>
                    </div>
                </div>

                <!-- Additional Prompt -->
                <div class="bg-white rounded-lg shadow-md p-5 transition-all hover:shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-comment-alt text-primary-500 mr-2"></i>Additional Instructions (Optional)
                    </h2>
                    <textarea id="additional-prompt" rows="3" placeholder="Any specific requirements for your visualization? Add custom styling instructions, layout preferences, or image links here." 
                        class="w-full p-3 border border-gray-300 rounded-md bg-white focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all"></textarea>
                    <p class="text-sm text-gray-500 mt-2">
                        Not satisfied with the first result? Add more specific requirements here and regenerate.
                    </p>
                </div>

                <!-- Model Parameters -->
                <div class="bg-white rounded-lg shadow-md p-5 transition-all hover:shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-sliders-h text-primary-500 mr-2"></i>Generation Settings
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Temperature -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="temperature" class="font-medium text-gray-900">Creativity Level: <span id="temperature-value" class="text-primary-600">1.0</span></label>
                                <button id="temperature-reset" class="text-xs text-primary-500 hover:underline">Reset</button>
                            </div>
                            <input type="range" id="temperature" min="0" max="1" step="0.1" value="1.0" 
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <p class="text-xs text-gray-500 mt-1">Lower values create more predictable, consistent results. Higher values allow more creativity and variation.</p>
                        </div>
                        
                        <!-- Max Tokens -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="max-tokens" class="font-medium text-gray-900">Output Length: <span id="max-tokens-value" class="text-primary-600">128000</span></label>
                                <button id="max-tokens-reset" class="text-xs text-primary-500 hover:underline">Reset</button>
                            </div>
                            <input type="range" id="max-tokens" min="1000" max="128000" step="1000" value="128000" 
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <p class="text-xs text-gray-500 mt-1">Controls how much content Claude can generate. Higher values allow for more extensive, detailed output.</p>
                        </div>
                        
                        <!-- Thinking Budget -->
                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label for="thinking-budget" class="font-medium text-gray-900">Thinking Depth: <span id="thinking-budget-value" class="text-primary-600">32000</span></label>
                                <button id="thinking-budget-reset" class="text-xs text-primary-500 hover:underline">Reset</button>
                            </div>
                            <input type="range" id="thinking-budget" min="1024" max="128000" step="1024" value="32000" 
                                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <p class="text-xs text-gray-500 mt-1">Allocates how much "thinking" Claude can do before responding. Higher values allow deeper analysis of complex content.</p>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="text-center">
                    <button id="generate-btn" disabled class="w-full bg-gray-300 text-gray-500 px-6 py-3 rounded-md text-lg font-bold shadow-md transition-all cursor-not-allowed">
                        <i class="fas fa-magic mr-2"></i>Generate Visualization
                    </button>
                    <p id="generate-error" class="text-red-500 mt-2 hidden">Please provide an API key and input content.</p>
                </div>
            </div>

            <!-- Output Section -->
            <div class="lg:col-span-7 space-y-6">
                <!-- Processing Status -->
                <div id="processing-status" class="bg-white rounded-lg shadow-md p-5 hidden">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold flex items-center">
                            <i class="fas fa-spinner fa-spin text-primary-500 mr-2"></i>Processing...
                        </h2>
                        <div id="elapsed-time" class="text-sm font-medium">
                            Elapsed: 0s
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                        <div id="progress-bar" class="bg-primary-500 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600">Claude is working on visualizing your content. This may take 5-20 minutes depending on your content size.</p>
                    <p class="text-sm text-gray-600 mt-2">Please keep this connection open until the process completes.</p>
                </div>

                <!-- Result Tabs and Content -->
                <div class="bg-white rounded-lg shadow-md p-5">
                    <div class="border-b border-gray-200 mb-4">
                        <ul class="flex flex-wrap -mb-px">
                            <li class="mr-2">
                                <button id="preview-tab" class="inline-block p-4 text-primary-600 border-b-2 border-primary-600 rounded-t-lg active">
                                    <i class="fas fa-eye mr-2"></i>Preview
                                </button>
                            </li>
                            <li class="mr-2">
                                <button id="html-tab" class="inline-block p-4 text-gray-500 hover:text-gray-600 border-b-2 border-transparent rounded-t-lg">
                                    <i class="fas fa-code mr-2"></i>HTML
                                </button>
                            </li>
                            <li class="mr-2">
                                <button id="thinking-tab" class="inline-block p-4 text-gray-500 hover:text-gray-600 border-b-2 border-transparent rounded-t-lg">
                                    <i class="fas fa-brain mr-2"></i>Thinking Process
                                </button>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Preview Tab Content -->
                    <div id="preview-content" class="tab-content hidden">
                        <div class="mb-4 flex justify-between items-center">
                            <h3 class="text-lg font-semibold">Live Preview</h3>
                            <button id="open-preview-btn" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500">
                                <i class="fas fa-external-link-alt mr-1"></i> Open in New Tab
                            </button>
                        </div>
                        <div class="bg-white dark:bg-gray-900 rounded-lg overflow-hidden iframe-container">
                            <div id="iframe-loader" class="iframe-loader hidden">
                                <div class="flex items-center">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary-500 mr-2"></div>
                                    <span>Loading preview...</span>
                                </div>
                            </div>
                            <iframe id="preview-iframe" class="w-full h-96 border-0" sandbox="allow-same-origin allow-scripts" loading="lazy"></iframe>
                        </div>
                    </div>
                    
                    <!-- HTML Tab Content -->
                    <div id="html-content" class="tab-content hidden">
                        <div class="mb-4 flex justify-between items-center">
                            <h3 class="text-lg font-semibold">Generated HTML</h3>
                            <div class="flex space-x-2">
                                <button id="copy-html-btn" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500">
                                    <i class="fas fa-copy mr-1"></i> Copy
                                </button>
                                <button id="download-html-btn" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500">
                                    <i class="fas fa-download mr-1"></i> Download
                                </button>
                            </div>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-800 p-1 rounded-lg overflow-hidden">
                            <textarea id="html-output" class="w-full h-96 font-mono text-xs p-4 bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded-md overflow-auto"></textarea>
                        </div>
                    </div>
                    
                    <!-- Thinking Tab Content -->
                    <div id="thinking-content" class="tab-content hidden">
                        <div id="thinking-output" class="h-[600px] overflow-auto rounded-md border border-gray-300 p-4 bg-gray-50 overscroll-contain">
                            <!-- Will be filled by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white shadow-inner mt-8">
        <div class="container mx-auto px-4 py-6 text-center">
            <p class="text-gray-600">Powered by <a href="https://www.anthropic.com/claude" class="text-primary-500 hover:underline" target="_blank">Anthropic Claude 3.7</a> with thinking capabilities</p>
            <p class="mt-2 text-gray-600">© 2025 - <span class="font-medium">File Visualizer</span> by <a href="https://www.linkedin.com/in/hubeiqiao/" class="text-primary-500 hover:underline" target="_blank">Joe Hu</a></p>
            <div class="mt-4">
                <a href="https://buy.stripe.com/6oEdTw8OQ86S0CYcMN" class="inline-flex items-center px-4 py-2 bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition-colors" target="_blank">
                    <i class="fas fa-coffee mr-2"></i> Appreciate this magic? Buy me a coffee!
                </a>
            </div>
        </div>
    </footer>

    <script src="app.js"></script>
    <!-- Special handler for Anthropic 529 overloaded errors -->
    <script src="static/529-handler.js"></script>
    <!-- Script to handle large HTML rendering and reconnection -->
    <script>
        // Store session data for reconnection
        let currentSessionId = null;
        let lastChunkId = null;
        let chunkCount = 0;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 10;  // Increased from 5 to 10
        let generatedHtml = '';
        let isRendering = false;
        let lastStreamTime = 0;
        let connectionMonitorInterval = null;
        let segmentBuffer = [];
        let receivedSegments = new Set();
        let lastCheckpointId = null;
        let lastCheckpointTime = 0;
        const PING_TIMEOUT = 15000; // 15 seconds without data is considered a timeout (reduced from 30s)
        const KEEPALIVE_INTERVAL = 10000; // Send ping every 10 seconds (reduced from 15s)
        const MAX_INACTIVITY_TIME = 60000; // Force page refresh after 1 minute of complete inactivity
        let keepaliveInterval = null;
        let forceReconnectTimeout = null;
        
        // Function to keep the connection alive
        function startKeepaliveHeartbeat() {
            if (keepaliveInterval) {
                clearInterval(keepaliveInterval);
            }
            
            // Send a ping every KEEPALIVE_INTERVAL to keep the connection alive
            keepaliveInterval = setInterval(() => {
                // Calculate time since last activity
                const timeSinceLastActivity = Date.now() - lastStreamTime;
                
                // If too much time has passed with no activity, force reconnect
                if (timeSinceLastActivity > MAX_INACTIVITY_TIME && currentSessionId) {
                    console.warn(`No activity for ${timeSinceLastActivity}ms - forcing reconnect`);
                    // Clear existing timeouts and intervals
                    clearKeepaliveAndMonitors();
                    
                    // Force reconnect
                    forceReconnect();
                    return;
                }
                
                // Use a no-op fetch to keep connection active
                fetch('/api/test?t=' + Date.now(), { 
                    method: 'GET',
                    keepalive: true,
                    headers: { 
                        'Cache-Control': 'no-cache, no-store',
                        'Connection': 'keep-alive'
                    }
                })
                .then(() => console.log('Heartbeat sent'))
                .catch(err => console.warn('Heartbeat failed:', err));
                
                // Check EventSource status
                if (window.eventSource) {
                    if (window.eventSource.readyState === 1) {
                        console.log('EventSource connection is active');
                    } else if (window.eventSource.readyState === 2 && reconnectAttempts < maxReconnectAttempts) {
                        console.warn('EventSource connection is closed - attempting reconnect');
                        handleReconnection();
                    }
                }
            }, KEEPALIVE_INTERVAL);
            
            // Setup a force reconnect timeout as a safety measure
            if (forceReconnectTimeout) {
                clearTimeout(forceReconnectTimeout);
            }
            
            // After 12 minutes (slightly less than 13 min timeout), force a reconnect 
            forceReconnectTimeout = setTimeout(() => {
                if (currentSessionId) {
                    console.warn('Forcing preventative reconnect after 12 minutes');
                    forceReconnect();
                }
            }, 720000); // 12 minutes
        }

        // Force a reconnect without incrementing the counter
        function forceReconnect() {
            console.log(`Forcing connection refresh`);
            
            // Update the UI to show reconnection attempt
            const processingStatus = document.getElementById('processing-status');
            if (processingStatus) {
                processingStatus.innerHTML += `
                    <div class="mt-2 text-sm text-blue-600">
                        <i class="fas fa-sync-alt fa-spin mr-2"></i> Refreshing connection...
                    </div>
                `;
            }
            
            // Close existing connection
            if (window.eventSource) {
                window.eventSource.close();
            }
            
            // Reset reconnect counter to give us full retry attempts
            reconnectAttempts = 0;
            
            // Attempt to resume the stream from last known position
            const resumeData = {
                session_id: currentSessionId,
                is_reconnect: true,
                last_chunk_id: lastChunkId,
                checkpoint_id: lastCheckpointId,
                api_key: document.getElementById('api-key').value,
                // Include the original request parameters
                content: window.lastProcessedContent || '',
                format_prompt: document.getElementById('additional-prompt').value,
                max_tokens: parseInt(document.getElementById('max-tokens').value),
                temperature: parseFloat(document.getElementById('temperature').value),
                thinking_budget: parseInt(document.getElementById('thinking-budget').value),
            };
            
            // Restart the streaming request
            startStreaming(resumeData);
        }

        // Clear all keepalive and monitoring intervals/timeouts
        function clearKeepaliveAndMonitors() {
            if (keepaliveInterval) {
                clearInterval(keepaliveInterval);
                keepaliveInterval = null;
            }
            
            if (connectionMonitorInterval) {
                clearInterval(connectionMonitorInterval);
                connectionMonitorInterval = null;
            }
            
            if (forceReconnectTimeout) {
                clearTimeout(forceReconnectTimeout);
                forceReconnectTimeout = null;
            }
        }

        // Stop the keepalive heartbeat
        function stopKeepaliveHeartbeat() {
            clearKeepaliveAndMonitors();
        }
        
        // Function to monitor connection health
        function startConnectionMonitor() {
            if (connectionMonitorInterval) {
                clearInterval(connectionMonitorInterval);
            }
            
            lastStreamTime = Date.now();
            connectionMonitorInterval = setInterval(() => {
                const currentTime = Date.now();
                if (currentTime - lastStreamTime > PING_TIMEOUT) {
                    console.warn('Connection timeout detected');
                    // Only attempt reconnect if we have a session
                    if (currentSessionId && reconnectAttempts < maxReconnectAttempts) {
                        handleReconnection();
                    } else {
                        clearKeepaliveAndMonitors();
                        // Show timeout message to user
                        document.getElementById('processing-status').innerHTML += `
                            <div class="bg-amber-100 text-amber-800 p-4 rounded-md mb-4">
                                <strong>Connection lost.</strong> The server may be taking too long to respond.
                                <button id="retry-button" class="ml-4 bg-amber-800 text-white px-3 py-1 rounded-md">
                                    Retry
                                </button>
                            </div>
                        `;
                        // Add event listener to the retry button
                        document.getElementById('retry-button')?.addEventListener('click', () => {
                            reconnectAttempts = 0;
                            handleReconnection();
                        });
                    }
                }
            }, 5000); // Check every 5 seconds
        }
        
        // Function to handle reconnection
        function handleReconnection() {
            reconnectAttempts++;
            console.log(`Attempting reconnection ${reconnectAttempts}/${maxReconnectAttempts}`);
            
            // Update the UI to show reconnection attempt
            const processingStatus = document.getElementById('processing-status');
            if (processingStatus) {
                processingStatus.innerHTML += `
                    <div class="mt-2 text-sm text-amber-600">
                        <i class="fas fa-sync-alt fa-spin mr-2"></i> Reconnecting (Attempt ${reconnectAttempts}/${maxReconnectAttempts})...
                    </div>
                `;
            }
            
            // Close existing connection if still open
            if (window.eventSource) {
                window.eventSource.close();
            }
            
            // Wait a short time before reconnecting to allow server to detect the disconnection
            setTimeout(() => {
                // Attempt to resume the stream from last known position
                const resumeData = {
                    session_id: currentSessionId,
                    is_reconnect: true,
                    last_chunk_id: lastChunkId,
                    checkpoint_id: lastCheckpointId,
                    api_key: document.getElementById('api-key').value,
                    // Include the original request parameters
                    content: window.lastProcessedContent || '',
                    format_prompt: document.getElementById('additional-prompt').value,
                    max_tokens: parseInt(document.getElementById('max-tokens').value),
                    temperature: parseFloat(document.getElementById('temperature').value),
                    thinking_budget: parseInt(document.getElementById('thinking-budget').value),
                };
                
                // Restart the streaming request
                startStreaming(resumeData);
            }, 1000);
        }
        
        // Function to update progress bar
        function updateProgress() {
            // Calculate estimated progress (approximation)
            const estimatedTotalChunks = 1000; // Rough estimate for large outputs
            const progress = Math.min(95, Math.round((chunkCount / estimatedTotalChunks) * 100));
            
            document.getElementById('progress-percentage').textContent = `${progress}%`;
            document.getElementById('progress-bar').style.width = `${progress}%`;
        }
    </script>
    <!-- Include near the end of the body -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Original init code here
            
            // Tab switching functionality
            function setupTabs() {
                const tabs = {
                    preview: {
                        tab: document.getElementById('preview-tab'),
                        content: document.getElementById('preview-content')
                    },
                    html: {
                        tab: document.getElementById('html-tab'),
                        content: document.getElementById('html-content')
                    },
                    thinking: {
                        tab: document.getElementById('thinking-tab'),
                        content: document.getElementById('thinking-content')
                    }
                };
                
                // Function to switch tabs
                function switchTab(tabName) {
                    // Deactivate all tabs
                    Object.keys(tabs).forEach(key => {
                        if (tabs[key].tab) {
                            tabs[key].tab.classList.remove('text-primary-600', 'border-primary-600');
                            tabs[key].tab.classList.add('text-gray-500', 'border-transparent');
                        }
                        if (tabs[key].content) {
                            tabs[key].content.classList.add('hidden');
                        }
                    });
                    
                    // Activate selected tab
                    if (tabs[tabName]) {
                        if (tabs[tabName].tab) {
                            tabs[tabName].tab.classList.remove('text-gray-500', 'border-transparent');
                            tabs[tabName].tab.classList.add('text-primary-600', 'border-primary-600');
                        }
                        if (tabs[tabName].content) {
                            tabs[tabName].content.classList.remove('hidden');
                        }
                    }
                }
                
                // Add click handlers
                Object.keys(tabs).forEach(key => {
                    if (tabs[key].tab) {
                        tabs[key].tab.addEventListener('click', () => switchTab(key));
                    }
                });
            }
            
            // Set up section navigation for large content
            function setupSectionNavigation() {
                const container = document.getElementById('preview-container');
                const prevSection = document.getElementById('prev-section');
                const nextSection = document.getElementById('next-section');
                const currentSectionDisplay = document.getElementById('current-section');
                const totalSectionsDisplay = document.getElementById('total-sections');
                
                if (!container || !prevSection || !nextSection) return;
                
                // Find all major section elements
                function findSections() {
                    const previewDoc = document.getElementById('preview-document');
                    if (!previewDoc) return [];
                    
                    // Look for significant section elements (headers, divs with specific classes, etc.)
                    const sections = Array.from(previewDoc.querySelectorAll('h1, h2, section, .section, [data-section]'));
                    
                    // If no specific sections found, create artificial sections based on content height
                    if (sections.length <= 1 && previewDoc.offsetHeight > 1000) {
                        const sectionHeight = 800; // pixels per section
                        const totalHeight = previewDoc.offsetHeight;
                        const numberOfSections = Math.ceil(totalHeight / sectionHeight);
                        
                        // Create array of positions
                        return Array.from({ length: numberOfSections }, (_, i) => {
                            return {
                                offsetTop: i * sectionHeight,
                                getBoundingClientRect: () => ({ top: i * sectionHeight - container.scrollTop })
                            };
                        });
                    }
                    
                    return sections;
                }
                
                // Variables to track current section
                let currentSectionIndex = 0;
                let sections = [];
                
                // Update the section indicator
                function updateSectionIndicator() {
                    currentSectionDisplay.textContent = currentSectionIndex + 1;
                    totalSectionsDisplay.textContent = sections.length;
                    
                    // Disable/enable buttons as needed
                    prevSection.disabled = currentSectionIndex === 0;
                    prevSection.classList.toggle('opacity-50', currentSectionIndex === 0);
                    nextSection.disabled = currentSectionIndex >= sections.length - 1;
                    nextSection.classList.toggle('opacity-50', currentSectionIndex >= sections.length - 1);
                }
                
                // Scroll to a specific section
                function scrollToSection(index) {
                    if (!sections.length || index < 0 || index >= sections.length) return;
                    
                    const section = sections[index];
                    container.scrollTo({
                        top: section.offsetTop,
                        behavior: 'smooth'
                    });
                    
                    currentSectionIndex = index;
                    updateSectionIndicator();
                }
                
                // Set up navigation buttons
                prevSection.addEventListener('click', () => {
                    if (currentSectionIndex > 0) {
                        scrollToSection(currentSectionIndex - 1);
                    }
                });
                
                nextSection.addEventListener('click', () => {
                    if (currentSectionIndex < sections.length - 1) {
                        scrollToSection(currentSectionIndex + 1);
                    }
                });
                
                // Initialize sections on content load
                const observer = new MutationObserver(() => {
                    // Update sections when content changes
                    sections = findSections();
                    if (sections.length > 1) {
                        document.getElementById('large-content-controls').classList.remove('hidden');
                        updateSectionIndicator();
                    } else {
                        document.getElementById('large-content-controls').classList.add('hidden');
                    }
                });
                
                // Start observing content changes
                const previewDoc = document.getElementById('preview-document');
                if (previewDoc) {
                    observer.observe(previewDoc, { childList: true, subtree: true });
                }
                
                // Update current section on scroll
                container.addEventListener('scroll', () => {
                    if (!sections.length) return;
                    
                    // Find the current section based on scroll position
                    const containerTop = container.scrollTop;
                    let newSectionIndex = 0;
                    
                    for (let i = 0; i < sections.length; i++) {
                        if (sections[i].offsetTop <= containerTop + 100) {
                            newSectionIndex = i;
                        } else {
                            break;
                        }
                    }
                    
                    if (newSectionIndex !== currentSectionIndex) {
                        currentSectionIndex = newSectionIndex;
                        updateSectionIndicator();
                    }
                });
            }
            
            // Set up HTML formatting
            function setupHtmlFormatting() {
                const formatButton = document.getElementById('format-html');
                const rawHtml = document.getElementById('raw-html');
                const copyButton = document.getElementById('copy-html');
                
                if (!formatButton || !rawHtml || !copyButton) return;
                
                // Format HTML with indentation
                formatButton.addEventListener('click', () => {
                    const html = rawHtml.textContent;
                    if (!html) return;
                    
                    try {
                        // Use a basic HTML prettifier
                        const formatted = prettifyHtml(html);
                        rawHtml.textContent = formatted;
                        
                        // Highlight code
                        if (window.Prism) {
                            Prism.highlightElement(rawHtml);
                        }
                    } catch (error) {
                        console.error('Error formatting HTML:', error);
                    }
                });
                
                // Copy HTML to clipboard
                copyButton.addEventListener('click', () => {
                    const html = rawHtml.textContent;
                    if (!html) return;
                    
                    navigator.clipboard.writeText(html)
                        .then(() => {
                            const originalText = copyButton.innerHTML;
                            copyButton.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
                            setTimeout(() => {
                                copyButton.innerHTML = originalText;
                            }, 2000);
                        })
                        .catch(error => {
                            console.error('Error copying to clipboard:', error);
                            copyButton.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Failed to copy';
                            setTimeout(() => {
                                copyButton.innerHTML = '<i class="fas fa-copy mr-2"></i>Copy HTML';
                            }, 2000);
                        });
                });
                
                // Simple HTML prettifier function
                function prettifyHtml(html) {
                    let formatted = '';
                    let indent = 0;
                    const tab = '  '; // 2 spaces for indentation
                    
                    // Split by < to get tags and content
                    html.split('<').forEach(node => {
                        if (!node) return;
                        
                        // Process different tag types
                        if (node.startsWith('/')) {
                            // Closing tag
                            indent--;
                            formatted += '\n' + tab.repeat(Math.max(0, indent)) + '<' + node;
                        } else if (node.startsWith('!--')) {
                            // Comment
                            formatted += '\n' + tab.repeat(indent) + '<' + node;
                        } else if (node.startsWith('script') || node.startsWith('style')) {
                            // Scripts and styles - keep as is
                            formatted += '\n' + tab.repeat(indent) + '<' + node;
                            if (!node.includes('</script>') && !node.includes('</style>')) {
                                indent++;
                            }
                        } else if (/^(area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)[\s>]/i.test(node)) {
                            // Self-closing tags
                            formatted += '\n' + tab.repeat(indent) + '<' + node;
                        } else {
                            // Opening tag
                            formatted += '\n' + tab.repeat(indent) + '<' + node;
                            if (!node.endsWith('/>') && !node.endsWith('/>') && !node.includes('</')) {
                                indent++;
                            }
                        }
                    });
                    
                    return formatted.trim();
                }
            }
            
            // Toggle preview size
            function setupPreviewResizing() {
                const toggleButton = document.getElementById('toggle-preview-size');
                const previewContainer = document.getElementById('preview-container');
                
                if (!toggleButton || !previewContainer) return;
                
                toggleButton.addEventListener('click', () => {
                    if (previewContainer.style.height === '800px') {
                        previewContainer.style.height = '600px';
                        toggleButton.innerHTML = '<i class="fas fa-expand-alt"></i>';
                    } else {
                        previewContainer.style.height = '800px';
                        toggleButton.innerHTML = '<i class="fas fa-compress-alt"></i>';
                    }
                });
            }
            
            // Initialize all UI components
            setupTabs();
            setupSectionNavigation();
            setupHtmlFormatting();
            setupPreviewResizing();
            
            // Override the generate functionality to use our enhanced streaming
            document.getElementById('generate-btn').addEventListener('click', function() {
                // Reset reconnection state
                reconnectAttempts = 0;
                currentSessionId = null;
                lastChunkId = null;
                chunkCount = 0;
                generatedHtml = '';
                
                // Set up UI
                document.getElementById('processing-status').classList.remove('hidden');
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-percentage').textContent = '0%';
                document.getElementById('generating-status').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
                document.getElementById('thinking-output').innerHTML = '';
                document.getElementById('raw-html').textContent = '';
                document.getElementById('preview-document').innerHTML = '';
                
                // Show loading indicator
                const loadingEl = document.getElementById('preview-loading');
                if (loadingEl) {
                    loadingEl.classList.remove('hidden');
                }
                
                // Reset tabs to preview tab
                const previewTab = document.getElementById('preview-tab');
                if (previewTab) {
                    previewTab.click();
                }
                
                // Get form data
                const apiKey = document.getElementById('api-key').value;
                let content = '';
                
                // Get content based on active tab
                if (document.getElementById('file-input').classList.contains('hidden')) {
                    // Text input is active
                    content = document.getElementById('input-text').value;
                } else {
                    // File input is active, get the content from memory
                    const fileInfo = document.getElementById('file-info');
                    content = window.uploadedFileContent || '';
                }
                
                // If no content, show error
                if (!content) {
                    document.getElementById('generate-error').classList.remove('hidden');
                    return;
                }
                
                const formatPrompt = document.getElementById('additional-prompt').value;
                const temperature = parseFloat(document.getElementById('temperature').value);
                const maxTokens = parseInt(document.getElementById('max-tokens').value);
                const thinkingBudget = parseInt(document.getElementById('thinking-budget').value);
                
                // Start streaming
                startStreaming({
                    api_key: apiKey,
                    content: content,
                    format_prompt: formatPrompt,
                    temperature: temperature,
                    max_tokens: maxTokens,
                    thinking_budget: thinkingBudget
                });
            });
        });
    </script>
    <!-- Add a module for progressive rendering just before the main script -->
    <script type="module">
        // Progressive rendering module
        class ProgressiveRenderer {
            constructor(options = {}) {
                this.options = {
                    chunkSize: options.chunkSize || 100000, // Characters per chunk
                    renderDelay: options.renderDelay || 50, // ms between chunk renders
                    maxDOMDepth: options.maxDOMDepth || 20, // Max nested DOM depth
                    renderTarget: options.renderTarget || document.body,
                    onProgress: options.onProgress || (() => {}),
                    onComplete: options.onComplete || (() => {}),
                    onError: options.onError || (() => {})
                };
                
                this.isRendering = false;
                this.pendingHTML = '';
                this.renderQueue = [];
                this.currentChunk = 0;
                this.totalChunks = 0;
            }
            
            async render(html, targetElement = null) {
                if (this.isRendering) {
                    // Queue this render request
                    this.renderQueue.push({ html, targetElement });
                    return;
                }
                
                try {
                    this.isRendering = true;
                    const target = targetElement || this.options.renderTarget;
                    
                    // Clear target if starting fresh
                    if (this.pendingHTML === '') {
                        target.innerHTML = '';
                    }
                    
                    // Append to pending HTML
                    this.pendingHTML += html;
                    
                    // If we don't have enough content yet, wait for more
                    if (this.pendingHTML.length < 1000 && !html.includes('</html>')) {
                        this.isRendering = false;
                        return;
                    }
                    
                    // Split content into manageable chunks
                    const chunks = this._splitIntoChunks(this.pendingHTML);
                    this.totalChunks = chunks.length;
                    
                    // Process each chunk with a delay to allow browser to breathe
                    for (let i = 0; i < chunks.length; i++) {
                        this.currentChunk = i + 1;
                        
                        // Report progress
                        this.options.onProgress({
                            current: this.currentChunk,
                            total: this.totalChunks,
                            percentage: Math.round((this.currentChunk / this.totalChunks) * 100)
                        });
                        
                        // Parse and render the chunk
                        await this._renderChunk(chunks[i], target);
                        
                        // Small delay to let the browser breathe
                        await new Promise(resolve => setTimeout(resolve, this.options.renderDelay));
                    }
                    
                    // Clear the pending HTML as it's been rendered
                    this.pendingHTML = '';
                    
                    // Call complete callback
                    this.options.onComplete();
                    
                    // If there are queued renders, process the next one
                    if (this.renderQueue.length > 0) {
                        const nextRender = this.renderQueue.shift();
                        this.render(nextRender.html, nextRender.targetElement);
                    } else {
                        this.isRendering = false;
                    }
                    
                } catch (error) {
                    console.error('Progressive rendering error:', error);
                    this.options.onError(error);
                    this.isRendering = false;
                }
            }
            
            _splitIntoChunks(html) {
                const chunkSize = this.options.chunkSize;
                
                // If HTML is smaller than chunk size, return as single chunk
                if (html.length <= chunkSize) {
                    return [html];
                }
                
                // For larger HTML, try to split at reasonable tag boundaries
                const chunks = [];
                let startPos = 0;
                
                while (startPos < html.length) {
                    let endPos = Math.min(startPos + chunkSize, html.length);
                    
                    // If we're not at the end, try to find a good split point
                    if (endPos < html.length) {
                        // Try to find the end of a tag
                        const tagEndPos = html.indexOf('>', endPos);
                        if (tagEndPos !== -1 && tagEndPos - endPos < 1000) {
                            endPos = tagEndPos + 1;
                        }
                    }
                    
                    chunks.push(html.substring(startPos, endPos));
                    startPos = endPos;
                }
                
                return chunks;
            }
            
            async _renderChunk(htmlChunk, targetElement) {
                // Create a document fragment for the chunk
                const parser = new DOMParser();
                let doc;
                
                try {
                    // Try to parse as complete HTML
                    doc = parser.parseFromString(htmlChunk, 'text/html');
                } catch (e) {
                    // If parsing fails, wrap in a div to ensure it's valid HTML
                    const wrappedHtml = `<div>${htmlChunk}</div>`;
                    doc = parser.parseFromString(wrappedHtml, 'text/html');
                }
                
                // Optimize the parsed content
                this._optimizeContent(doc.body);
                
                // Use a document fragment for better performance
                const fragment = document.createDocumentFragment();
                
                // Move all nodes from the body to the fragment
                while (doc.body.firstChild) {
                    fragment.appendChild(doc.body.firstChild);
                }
                
                // Append the fragment to the target element
                targetElement.appendChild(fragment);
            }
            
            _optimizeContent(element, depth = 0) {
                // Prevent excessively deep DOM trees
                if (depth > this.options.maxDOMDepth) {
                    // If we're too deep, collapse this branch
                    if (element.parentNode) {
                        const replacement = document.createElement('div');
                        replacement.textContent = '...content collapsed (too deeply nested)...';
                        replacement.className = 'collapsed-content';
                        element.parentNode.replaceChild(replacement, element);
                    }
                    return;
                }
                
                // Process all child elements
                const children = Array.from(element.children);
                for (const child of children) {
                    // Optimize images
                    if (child.tagName === 'IMG') {
                        child.setAttribute('loading', 'lazy');
                        // Add error handling
                        child.onerror = () => {
                            child.style.display = 'none';
                        };
                    }
                    
                    // Optimize tables
                    if (child.tagName === 'TABLE') {
                        // If table is very large, add scrolling container
                        if (child.rows.length > 30 || (child.rows[0] && child.rows[0].cells.length > 10)) {
                            const wrapper = document.createElement('div');
                            wrapper.style.overflow = 'auto';
                            wrapper.style.maxHeight = '500px';
                            wrapper.style.maxWidth = '100%';
                            child.parentNode.insertBefore(wrapper, child);
                            wrapper.appendChild(child);
                        }
                    }
                    
                    // Recursively process child elements
                    this._optimizeContent(child, depth + 1);
                }
            }
        }
        
        // Export the renderer to window for use in other scripts
        window.ProgressiveRenderer = ProgressiveRenderer;
        
        // Initialize the renderer when document is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.progressiveRenderer = new ProgressiveRenderer({
                renderTarget: document.getElementById('preview-document'),
                onProgress: (progress) => {
                    const loadingEl = document.getElementById('preview-loading');
                    if (loadingEl) {
                        if (progress.percentage > 0) {
                            loadingEl.innerHTML = `
                                <div class="text-center">
                                    <div class="mb-2">
                                        <div class="w-48 h-2 bg-gray-200 rounded-full">
                                            <div class="h-2 bg-primary-600 rounded-full" style="width: ${progress.percentage}%"></div>
                                        </div>
                                    </div>
                                    <p class="text-primary-600">Rendering content... ${progress.percentage}%</p>
                                </div>
                            `;
                        }
                    }
                },
                onComplete: () => {
                    const loadingEl = document.getElementById('preview-loading');
                    if (loadingEl) {
                        loadingEl.classList.add('hidden');
                    }
                    
                    // Check if we need to show section navigation for large content
                    const previewDoc = document.getElementById('preview-document');
                    if (previewDoc && previewDoc.offsetHeight > 2000) {
                        document.getElementById('large-content-controls').classList.remove('hidden');
                    }
                },
                onError: (error) => {
                    console.error('Rendering error:', error);
                    const loadingEl = document.getElementById('preview-loading');
                    if (loadingEl) {
                        loadingEl.innerHTML = `
                            <div class="text-center bg-red-50 p-4 rounded-md">
                                <p class="text-red-600">Error rendering content: ${error.message}</p>
                                <button id="retry-render" class="mt-2 bg-red-600 text-white px-3 py-1 rounded">Retry</button>
                            </div>
                        `;
                    }
                }
            });
        });
    </script>
    
    <!-- Add handler for overloaded API responses -->
    <script>
        // Handle API overloaded status updates
        document.addEventListener('DOMContentLoaded', function() {
            // Create a handler for the status event
            if (window.EventSource) {
                document.addEventListener('stream-status', function(e) {
                    try {
                        const statusData = e.detail;
                        console.log('Status event received:', statusData);
                        
                        // Update the UI to show the status
                        const processingStatus = document.getElementById('processing-status');
                        if (processingStatus) {
                            // Check if this is a retry status message
                            if (statusData.message && statusData.message.includes('overloaded')) {
                                // Show a retry message
                                const retryCount = statusData.retry || 0;
                                const maxRetries = statusData.max_retries || 8;
                                const progressPercent = Math.min(100, Math.round((retryCount / maxRetries) * 100));
                                
                                // Add a status message to the UI
                                processingStatus.innerHTML += `
                                    <div class="mt-2 bg-blue-50 text-blue-800 p-3 rounded-md flex items-center retry-message">
                                        <div class="mr-3">
                                            <i class="fas fa-sync-alt fa-spin"></i>
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-medium">${statusData.message}</div>
                                            <div class="mt-1 w-full bg-blue-200 rounded-full h-2">
                                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${progressPercent}%"></div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                
                                // The server is already handling retry, no need for client-side retry
                                window.lastStreamTime = Date.now(); // Reset timeout to prevent client reconnection
                            } else {
                                // Generic status message
                                processingStatus.innerHTML += `
                                    <div class="mt-2 text-gray-600">
                                        <i class="fas fa-info-circle mr-2"></i> ${statusData.message}
                                    </div>
                                `;
                            }
                        }
                    } catch (err) {
                        console.error('Error processing status event:', err);
                    }
                });
                
                // Create a handler for error events that include 529 code
                document.addEventListener('stream-error', function(e) {
                    try {
                        const errorData = e.detail;
                        console.log('Stream error received:', errorData);
                        
                        // Update the UI to show the error
                        const processingStatus = document.getElementById('processing-status');
                        if (processingStatus) {
                            // Remove any existing retry messages
                            const retryMessages = processingStatus.querySelectorAll('.retry-message');
                            retryMessages.forEach(msg => msg.remove());
                            
                            // Check if this is an overload error (529)
                            if (errorData.code === 529) {
                                processingStatus.innerHTML += `
                                    <div class="bg-blue-100 text-blue-800 p-4 rounded-md mt-4">
                                        <strong>AI Service Overloaded</strong>
                                        <p class="mt-2">The AI service is currently experiencing high demand. Please try again later.</p>
                                        <button id="retry-button" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded-md">
                                            Try Again
                                        </button>
                                    </div>
                                `;
                            } else {
                                // Regular error
                                processingStatus.innerHTML += `
                                    <div class="bg-red-100 text-red-800 p-4 rounded-md mt-4">
                                        <strong>Error:</strong> ${errorData.error || 'Unknown error'}
                                        ${errorData.details ? `<pre class="mt-2 text-xs overflow-auto">${errorData.details}</pre>` : ''}
                                    </div>
                                `;
                            }
                            
                            // Add retry button event handler
                            document.getElementById('retry-button')?.addEventListener('click', function() {
                                // For overload errors, we should wait a bit longer before retrying
                                setTimeout(() => {
                                    window.reconnectAttempts = 0;
                                    
                                    // Create a fresh session
                                    window.currentSessionId = null;
                                    window.lastChunkId = null;
                                    
                                    // Clear status area and regenerate
                                    processingStatus.innerHTML = '';
                                    document.getElementById('generate-btn').click();
                                }, 3000);
                            });
                        }
                    } catch (err) {
                        console.error('Error processing error event:', err);
                    }
                });
            }
        });
    </script>
</body>
</html> 